<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒêo Ch·ªâ S·ªë S·ª©c Kh·ªèe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="auth.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="min-h-screen bg-[#F0F4F8] flex flex-col items-center">

  <div id="menu-container" class="w-full"></div>
  <script>
    fetch("menu.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("menu-container").innerHTML = html;
        const socket = io();
        socket.on('pill/data/status', (status) => {
          const jsonStatus = JSON.parse(status);
          const wifiIcon = document.getElementById('wifi-status');
          if (wifiIcon) {
            wifiIcon.innerHTML = jsonStatus.status === 'online' ? 'üì∂' : 'üì¥';
            wifiIcon.className = jsonStatus.status === 'online' ? 'text-green-500 text-xl animate-pulse' : 'text-red-500 text-xl';
          }
        });
      });
  </script>

  <main class="pt-32 pb-16 px-6 w-full max-w-5xl flex flex-col items-center">

    <header class="text-center mb-12">
      <h1 class="text-2xl font-extrabold text-indigo-700 tracking-tight">
        ü©∫ Theo D√µi Ch·ªâ S·ªë Sinh H√≥a
      </h1>
      <p class="text-gray-500 mt-2">D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr·ª±c ti·∫øp t·ª´ thi·∫øt b·ªã ƒëeo</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">

      <div
        class="bg-white rounded-3xl shadow-xl border border-red-50 p-8 flex flex-col items-center transition-all hover:shadow-2xl hover:-translate-y-1">
        <div class="bg-red-50 p-4 rounded-full mb-4">
          <span class="text-5xl">‚ù§Ô∏è</span>
        </div>
        <h2 class="text-xl font-bold text-gray-800 mb-6">Huy·∫øt √°p & Nh·ªãp tim</h2>

        <div class="w-full mb-4">
          <label class="block text-xs font-semibold text-gray-600 mb-2">Ch·ªçn b·∫£n ghi:</label>
          <select id="bpRecordSelect" onchange="loadSelectedBpRecord()"
            class="w-full px-3 py-2 bg-white border-2 border-red-200 rounded-lg text-sm text-gray-700 font-medium focus:outline-none focus:border-red-400 transition-all">
            <option value="">ƒêang t·∫£i...</option>
          </select>
        </div>

        <div class="w-full border-t border-gray-100 pt-6 space-y-4">
          <div class="flex justify-between items-center">
            <p class="text-sm text-gray-400 font-medium uppercase tracking-wider">Nh·ªãp tim</p>
            <p id="heartBeatValue" class="text-3xl font-black text-red-500">-- <span
                class="text-lg font-normal">bpm</span></p>
          </div>
          <div class="flex justify-between items-center">
            <p class="text-sm text-gray-400 font-medium uppercase tracking-wider">Huy·∫øt √°p t√¢m thu</p>
            <p id="systolicValue" class="text-3xl font-black text-red-600">-- <span
                class="text-lg font-normal">mmHg</span></p>
          </div>
          <div class="flex justify-between items-center">
            <p class="text-sm text-gray-400 font-medium uppercase tracking-wider">Huy·∫øt √°p t√¢m tr∆∞∆°ng</p>
            <p id="diastolicValue" class="text-3xl font-black text-red-700">-- <span
                class="text-lg font-normal">mmHg</span></p>
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-3xl shadow-xl border border-blue-50 p-8 flex flex-col items-center transition-all hover:shadow-2xl hover:-translate-y-1">
        <div class="bg-blue-50 p-4 rounded-full mb-4">
          <span class="text-5xl">üå¨Ô∏è</span>
        </div>
        <h2 class="text-xl font-bold text-gray-800 mb-6">Oxi m√°u & Nhi·ªát ƒë·ªô</h2>

        <div class="w-full mb-4">
          <label class="block text-xs font-semibold text-gray-600 mb-2">Ch·ªçn b·∫£n ghi:</label>
          <select id="spo2RecordSelect" onchange="loadSelectedSpo2Record()"
            class="w-full px-3 py-2 bg-white border-2 border-blue-200 rounded-lg text-sm text-gray-700 font-medium focus:outline-none focus:border-blue-400 transition-all">
            <option value="">ƒêang t·∫£i...</option>
          </select>
        </div>

        <div class="flex justify-around w-full border-t border-gray-100 pt-6">
          <div class="text-center">
            <p class="text-sm text-gray-400 font-medium uppercase tracking-wider">SpO‚ÇÇ</p>
            <p id="oxygenValue" class="text-3xl font-black text-blue-600 mt-1">-- <span
                class="text-lg font-normal">%</span></p>
          </div>
          <div class="w-px bg-gray-100"></div>
          <div class="text-center">
            <p class="text-sm text-gray-400 font-medium uppercase tracking-wider">Nhi·ªát ƒë·ªô</p>
            <p id="tempValue" class="text-3xl font-black text-emerald-500 mt-1">-- <span
                class="text-lg font-normal">¬∞C</span></p>
          </div>
        </div>
      </div>

    </div>

    <div class="w-full mt-12 space-y-8">
      <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Bi·ªÉu ƒë·ªì Huy·∫øt √°p & Nh·ªãp tim</h3>
        <canvas id="bpChart"></canvas>
      </div>

      <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Bi·ªÉu ƒë·ªì Oxi m√°u & Nhi·ªát ƒë·ªô</h3>
        <canvas id="spo2Chart"></canvas>
      </div>
    </div>

  </main>

  <script>
    let bpChart = null;
    let spo2Chart = null;
    let allBpData = [];
    let allSpo2Data = [];
    const userId = "690583a8d3dde5f187c1cd58"; // User ID c·ªë ƒë·ªãnh

    // Load t·∫•t c·∫£ records c·ªßa user
    async function loadAllRecords() {
      try {
        // Fetch BP data
        const bpRes = await fetch(`/api/v1/measurement/bp/${userId}`);
        allBpData = await bpRes.json();
        
        // Fetch SPO2 data
        const spo2Res = await fetch(`/api/v1/measurement/spo2/${userId}`);
        allSpo2Data = await spo2Res.json();

        // Populate dropdown v·ªõi c√°c records
        populateBpDropdown();
        populateSpo2Dropdown();
      } catch (err) {
        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
      }
    }

    // Populate dropdown BP v·ªõi danh s√°ch records
    function populateBpDropdown() {
      const select = document.getElementById('bpRecordSelect');
      select.innerHTML = '<option value="">Ch·ªçn b·∫£n ghi...</option>';

      if (!allBpData || allBpData.length === 0) {
        return;
      }

      // S·∫Øp x·∫øp theo th·ªùi gian gi·∫£m d·∫ßn (m·ªõi nh·∫•t tr∆∞·ªõc)
      const sortedBpData = [...allBpData].sort((a, b) => {
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      sortedBpData.forEach((record, index) => {
        if (record.createdAt) {
          const date = new Date(record.createdAt);
          const option = document.createElement('option');
          option.value = record._id || index;
          option.textContent = date.toLocaleString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
          select.appendChild(option);
        }
      });

      // Ch·ªçn record m·ªõi nh·∫•t m·∫∑c ƒë·ªãnh
      if (sortedBpData.length > 0) {
        select.value = sortedBpData[0]._id || 0;
        loadSelectedBpRecord();
      }
    }

    // Populate dropdown SPO2 v·ªõi danh s√°ch records
    function populateSpo2Dropdown() {
      const select = document.getElementById('spo2RecordSelect');
      select.innerHTML = '<option value="">Ch·ªçn b·∫£n ghi...</option>';

      if (!allSpo2Data || allSpo2Data.length === 0) {
        return;
      }

      // S·∫Øp x·∫øp theo th·ªùi gian gi·∫£m d·∫ßn (m·ªõi nh·∫•t tr∆∞·ªõc)
      const sortedSpo2Data = [...allSpo2Data].sort((a, b) => {
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      sortedSpo2Data.forEach((record, index) => {
        if (record.createdAt) {
          const date = new Date(record.createdAt);
          const option = document.createElement('option');
          option.value = record._id || index;
          option.textContent = date.toLocaleString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
          select.appendChild(option);
        }
      });

      // Ch·ªçn record m·ªõi nh·∫•t m·∫∑c ƒë·ªãnh
      if (sortedSpo2Data.length > 0) {
        select.value = sortedSpo2Data[0]._id || 0;
        loadSelectedSpo2Record();
      }
    }

    // Load BP record ƒë∆∞·ª£c ch·ªçn
    function loadSelectedBpRecord() {
      const selectedId = document.getElementById('bpRecordSelect').value;
      
      if (!selectedId) {
        // Reset hi·ªÉn th·ªã
        document.getElementById("heartBeatValue").innerHTML = '-- <span class="text-lg font-normal">bpm</span>';
        document.getElementById("systolicValue").innerHTML = '-- <span class="text-lg font-normal">mmHg</span>';
        document.getElementById("diastolicValue").innerHTML = '-- <span class="text-lg font-normal">mmHg</span>';
        return;
      }

      // T√¨m BP record theo ID
      const selectedBp = allBpData.find(record => record._id === selectedId || record._id?.toString() === selectedId);

      // Hi·ªÉn th·ªã d·ªØ li·ªáu
      if (selectedBp) {
        document.getElementById("heartBeatValue").innerHTML = `${selectedBp.heart_beat || '--'} <span class="text-lg font-normal">bpm</span>`;
        document.getElementById("systolicValue").innerHTML = `${selectedBp.systolic || '--'} <span class="text-lg font-normal">mmHg</span>`;
        document.getElementById("diastolicValue").innerHTML = `${selectedBp.diastolic || '--'} <span class="text-lg font-normal">mmHg</span>`;
      } else {
        document.getElementById("heartBeatValue").innerHTML = '-- <span class="text-lg font-normal">bpm</span>';
        document.getElementById("systolicValue").innerHTML = '-- <span class="text-lg font-normal">mmHg</span>';
        document.getElementById("diastolicValue").innerHTML = '-- <span class="text-lg font-normal">mmHg</span>';
      }

      // V·∫Ω bi·ªÉu ƒë·ªì v·ªõi t·∫•t c·∫£ d·ªØ li·ªáu BP
      drawBpChart(allBpData);
    }

    // Load SPO2 record ƒë∆∞·ª£c ch·ªçn
    function loadSelectedSpo2Record() {
      const selectedId = document.getElementById('spo2RecordSelect').value;
      
      if (!selectedId) {
        // Reset hi·ªÉn th·ªã
        document.getElementById("tempValue").innerHTML = '-- <span class="text-lg font-normal">¬∞C</span>';
        document.getElementById("oxygenValue").innerHTML = '-- <span class="text-lg font-normal">%</span>';
        return;
      }

      // T√¨m SPO2 record theo ID
      const selectedSpo2 = allSpo2Data.find(record => record._id === selectedId || record._id?.toString() === selectedId);

      // Hi·ªÉn th·ªã d·ªØ li·ªáu
      if (selectedSpo2) {
        document.getElementById("tempValue").innerHTML = `${selectedSpo2.temperature || '--'} <span class="text-lg font-normal">¬∞C</span>`;
        document.getElementById("oxygenValue").innerHTML = `${selectedSpo2.spo2 || '--'} <span class="text-lg font-normal">%</span>`;
      } else {
        document.getElementById("tempValue").innerHTML = '-- <span class="text-lg font-normal">¬∞C</span>';
        document.getElementById("oxygenValue").innerHTML = '-- <span class="text-lg font-normal">%</span>';
      }

      // V·∫Ω bi·ªÉu ƒë·ªì v·ªõi t·∫•t c·∫£ d·ªØ li·ªáu SPO2
      drawSpo2Chart(allSpo2Data);
    }

    // V·∫Ω bi·ªÉu ƒë·ªì BP
    function drawBpChart(bpData) {
      const ctx = document.getElementById('bpChart').getContext('2d');
      
      if (bpChart) {
        bpChart.destroy();
      }

      if (!bpData || bpData.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = '16px Inter';
        ctx.fillStyle = '#9CA3AF';
        ctx.textAlign = 'center';
        ctx.fillText('Ch∆∞a c√≥ d·ªØ li·ªáu', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }

      const labels = bpData.map(item => {
        const date = new Date(item.createdAt);
        return date.toLocaleString('vi-VN', { 
          day: '2-digit', 
          month: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      });

      bpChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Nh·ªãp tim (bpm)',
              data: bpData.map(item => item.heart_beat),
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'Huy·∫øt √°p t√¢m thu (mmHg)',
              data: bpData.map(item => item.systolic),
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              yAxisID: 'y1'
            },
            {
              label: 'Huy·∫øt √°p t√¢m tr∆∞∆°ng (mmHg)',
              data: bpData.map(item => item.diastolic),
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Nh·ªãp tim (bpm)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Huy·∫øt √°p (mmHg)'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });
    }

    // V·∫Ω bi·ªÉu ƒë·ªì SPO2
    function drawSpo2Chart(spo2Data) {
      const ctx = document.getElementById('spo2Chart').getContext('2d');
      
      if (spo2Chart) {
        spo2Chart.destroy();
      }

      if (!spo2Data || spo2Data.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = '16px Inter';
        ctx.fillStyle = '#9CA3AF';
        ctx.textAlign = 'center';
        ctx.fillText('Ch∆∞a c√≥ d·ªØ li·ªáu', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }

      const labels = spo2Data.map(item => {
        const date = new Date(item.createdAt);
        return date.toLocaleString('vi-VN', { 
          day: '2-digit', 
          month: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      });

      spo2Chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'SpO‚ÇÇ (%)',
              data: spo2Data.map(item => item.spo2),
              borderColor: 'rgb(37, 99, 235)',
              backgroundColor: 'rgba(37, 99, 235, 0.1)',
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'Nhi·ªát ƒë·ªô (¬∞C)',
              data: spo2Data.map(item => item.temperature),
              borderColor: 'rgb(16, 185, 129)',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'SpO‚ÇÇ (%)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Nhi·ªát ƒë·ªô (¬∞C)'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });
    }

    // Kh·ªüi t·∫°o khi trang load
    window.onload = async () => {
      await loadAllRecords();
    };
  </script>

</body>

</html>