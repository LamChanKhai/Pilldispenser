<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ“„ OCR & AI ÄÆ¡n Thuá»‘c</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="auth.js"></script>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center p-6">
    <h1 class="text-2xl md:text-3xl font-bold text-blue-600 mb-6">ğŸ“· OCR & AI Xá»­ LÃ½ ÄÆ¡n Thuá»‘c</h1>

    <!-- Upload Box -->
    <div class="border-2 border-dashed border-blue-500 rounded-2xl bg-white p-8 max-w-sm w-full text-center cursor-pointer hover:bg-blue-50 transition"
        onclick="document.getElementById('fileInput').click()">
        <p class="text-gray-600">ğŸ“¸ Báº¥m Ä‘á»ƒ táº£i hoáº·c chá»¥p áº£nh Ä‘Æ¡n thuá»‘c</p>
        <input type="file" accept="image/*" id="fileInput" class="hidden" capture="camera">
    </div>

    <!-- Preview -->
    <div
        class="mt-4 w-72 h-48 border border-gray-300 rounded-lg flex items-center justify-center bg-white overflow-hidden">
        <img id="preview" alt="áº¢nh Ä‘Æ¡n thuá»‘c" class="max-w-full max-h-full hidden">
    </div>

    <!-- Manual Input -->
    <div class="mt-6 w-full max-w-lg text-center">
        <h3 class="text-lg font-semibold mb-2">âœï¸ Hoáº·c nháº­p ná»™i dung OCR thá»§ cÃ´ng</h3>
        <textarea id="manualInput" placeholder="Nháº­p vÄƒn báº£n OCR hoáº·c ná»™i dung Ä‘Æ¡n thuá»‘c..."
            class="w-full h-32 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-400 outline-none"></textarea>
        <button id="sendBtn"
            class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg shadow">
            Gá»­i Ä‘áº¿n AI
        </button>
    </div>

    <!-- Results -->
    <div class="mt-8 w-full max-w-5xl flex flex-col md:flex-row gap-4">
        <div class="flex-1 bg-white rounded-xl shadow p-4">
            <h4 class="font-semibold text-gray-700 mb-2">ğŸ“ Káº¿t quáº£ OCR</h4>
            <div id="ocrTextBox" class="text-sm text-gray-800 whitespace-pre-wrap overflow-y-auto max-h-[500px]">
                â³ Káº¿t quáº£ OCR sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y...
            </div>
        </div>

        <div class="flex-1 bg-white rounded-xl shadow p-4">
            <h4 class="font-semibold text-gray-700 mb-2">ğŸ¤– Káº¿t quáº£ AI</h4>
            <div id="aiResultBox" class="text-sm text-gray-800 whitespace-pre-wrap overflow-y-auto max-h-[500px]">
                ğŸ¤– Káº¿t quáº£ AI xá»­ lÃ½ sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y...
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        const fileInput = document.getElementById("fileInput");
        const preview = document.getElementById("preview");
        const ocrBox = document.getElementById("ocrTextBox");
        const aiBox = document.getElementById("aiResultBox");
        const sendBtn = document.getElementById("sendBtn");

        fileInput.addEventListener("change", handleImage);
        sendBtn.addEventListener("click", sendManualText);

        async function handleImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                preview.src = e.target.result;
                preview.classList.remove("hidden");

                ocrBox.textContent = "â³ Äang nháº­n dáº¡ng vÄƒn báº£n...";
                aiBox.textContent = "ğŸ¤– Äang chá» káº¿t quáº£ tá»« AI...";

                try {
                    const { data: { text } } = await Tesseract.recognize(
                        e.target.result, 'vie+eng', { logger: info => console.log(info) }
                    );
                    ocrBox.textContent = text.trim() || "KhÃ´ng Ä‘á»c Ä‘Æ°á»£c vÄƒn báº£n tá»« áº£nh.";
                    if (text.trim()) sendToAI(text);
                } catch (err) {
                    console.error("Lá»—i OCR:", err);
                    ocrBox.textContent = "âŒ Lá»—i khi Ä‘á»c áº£nh.";
                }
            };
            reader.readAsDataURL(file);
        }

        async function sendManualText() {
            const text = document.getElementById("manualInput").value.trim();
            if (!text) return alert("âš ï¸ Vui lÃ²ng nháº­p ná»™i dung trÆ°á»›c khi gá»­i!");
            ocrBox.textContent = text;
            aiBox.textContent = "ğŸ§  Äang gá»­i Ä‘áº¿n AI xá»­ lÃ½...";
            await sendToAI(text);
        }

        async function sendToAI(text) {
            try {
                const response = await fetch("/api/v1/gemini", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text }),
                });
                const data = await response.json();
                aiBox.textContent = data.result || "âš ï¸ KhÃ´ng cÃ³ pháº£n há»“i tá»« AI.";
            } catch (err) {
                console.error("Lá»—i gá»i API:", err);
                aiBox.textContent = "âŒ Lá»—i khi gá»i AI.";
            }
        }
    </script>
</body>

</html>